# 打鍵数・正確率の計算方式

## 概要

このアプリケーションでは、タイピングの指標として「速度」と「正確率」を表示します。これらは異なる「空間」で定義される指標であり、それぞれ明確な目的を持っています。

## 2つの空間

### 1. 打鍵数空間 (Keystroke Space)
- 物理的なキー操作の数
- IME変換、削除、カーソル移動などすべての操作を含む
- ユーザーの「努力」や「編集プロセス」を反映

### 2. 文字数空間 (Character Space)
- 入力欄に確定挿入された文字の数
- 最終的に「生成された」テキスト量を表す
- タイピングの「生産性」を反映

## 実装された指標

### 正確率（寄与率）
- **定義**: 目標テキストに近づく編集の割合
- **空間**: 打鍵数空間（編集イベント単位）
- **計算方法**: 
  - 各編集イベント（beforeinput、compositionend）の前後でLevenshtein距離を計算
  - 距離が縮まった → **寄与編集** (Positive)
  - 距離が広がった → **非寄与編集** (Negative)
  - 距離が変わらない → **中立編集** (Neutral)
  - **寄与率 = 寄与編集数 / (寄与編集数 + 非寄与編集数) × 100**
  - 中立編集は母数から除外（カーソル移動等で不当に下がらないため）

### 速度（文字/分）
- **定義**: 1分あたりの確定挿入文字数
- **空間**: 文字数空間
- **計算方法**: `確定挿入文字数 / 経過時間（分）`
- **特徴**: 削除操作は速度を下げない（確定挿入のみをカウント）

## 利点

### 先頭一致時の直感性
先頭から順に正しく入力している場合、各編集で距離が1ずつ縮まるため、直感的に寄与としてカウントされます。

### 途中編集への対応
- 括弧ペアの自動挿入（`()`を1操作で入力）→ 距離が2縮まれば寄与として評価
- 先に括弧を入力してから中身を入力 → 全体の距離が縮まる限り寄与として評価
- カーソル移動や選択範囲の編集 → 正しく処理される

### 削除操作の適切な評価
- 誤った文字の削除 → 距離が縮まり寄与として評価
- 正しい文字の削除 → 距離が広がり非寄与として評価

### IME入力の統一的な扱い
- IME確定を1つの編集イベントとして評価
- 確定文字列全体で距離を判定するため、変換精度が反映される

## 技術的な詳細

### イベントハンドリング
- `beforeinput`: 確定編集イベント（insert/delete/paste等）で寄与判定
- `compositionend`: IME確定時に寄与判定
- `input`: 表示更新と進捗保存のみ（カウントは行わない）

### 距離計算
- Levenshtein距離（編集距離）を使用
- 動的計画法（DP）による O(m×n) の実装
- 長文でのパフォーマンス最適化は今後の課題

### 進捗の保存と復元
- localStorage に以下を保存:
  - `committedChars`: 確定挿入文字数
  - `contributionPositive`: 寄与編集数
  - `contributionNegative`: 非寄与編集数
  - `contributionNeutral`: 中立編集数

## 表示項目

### ゲーム画面
- **正確さ（寄与率）**: リアルタイムで更新される寄与率
- **速度**: リアルタイムで更新される文字/分
- **進捗**: 完了した文章の割合

### 結果画面
- **タイム**: 経過時間
- **正確さ（寄与率）**: 最終的な寄与率
- **平均速度**: 最終的な文字/分
- **確定文字数**: 確定挿入された文字の総数
- **寄与編集数**: 目標に近づいた編集の回数

## 今後の拡張可能性

### 追加指標の候補
- **Characters per Edit (CPE)**: 確定文字数 / 編集回数
- **編集効率**: 寄与編集数 / 全編集数（中立を含む）
- **最終一致率**: 最終テキストと目標の一致度（品質指標）

### パフォーマンス最適化
- 長文での距離計算の最適化（バンド制限、差分計算）
- Damerau-Levenshtein距離への拡張（隣接入替を1手扱い）

## 参考文献
- Levenshtein Distance (編集距離)
- beforeinput Event API
- IME Composition Events

